<h1>Custom Auth Tutorial</h1>

  {{#if user}}
    <div class="form login-form">
      <p>Logged in as <strong>{{user.username}}</strong></p>
      <div class="buttons">
        <a class="button logout" href="#">Logout</a>
      </div>
    </div>
  {{else}}
    <div class="form login-form">
      <input type="text" name="username" placeholder="username">
      <input type="text" name="password" placeholder="password">
      <div class="buttons">
        <a class="button login" href="/">Login</a>
        <a class="button signup" href="/register">Signup</a>
      </div>
    </div>
    <div class="form signup-form">
      <input type="text" name="username" placeholder="username">
      <input type="text" name="email" placeholder="email">
      <input type="text" name="password" placeholder="password">
      <div class="buttons">
        <a class="button login" href="/">Login</a>
        <a class="button signup" href="/register">Signup</a>
      </div>
    </div>
  {{/if}}

<script>

  $(function() {
    if (window.location.pathname === '/') {
      $('.signup-form').remove()
      $('.login').on('click', login);
    }
    if (window.location.pathname === '/register') {
      $('.login-form').remove()
      $('.signup').on('click', signup);
    }
    if ($('.logout').length) {
      $('.logout').on('click', logout);
    }
  })

  function validInput(names) {
    for(let i=0; i<names.length; i++) {
      if (!$('[name="'+ names[i] +'"]').val()) {
        return false;
      }
    }
    return true;
  }

  function login(e) {
    e.preventDefault();
    if (!validInput(['username', 'password'])) return;
    $.ajax('/login', {
      method: 'POST',
      data: {
        username: $('[name="username"]').val(),
        password: $('[name="password"]').val()
      }
    }).done(user => {
      $.cookie('auth_token', user.token, { expires: 7 });
      window.location.reload()
    }).fail((err) => alert(err.responseText))
  }

  function signup(e) {
    e.preventDefault();
    if (!validInput(['username', 'password', 'email'])) return;
    $.ajax('/register', {
      method: 'POST',
      data: {
        username: $('[name="username"]').val(),
        email: $('[name="email"]').val(),
        password: $('[name="password"]').val()
      }
    }).then(user => {
      $.cookie('auth_token', user.token, { expires: 7 });
      window.location = '/'
    })
  }

  function logout(e) {
    e.preventDefault();
    $.ajax('/logout', {
      method: 'DELETE',
      data: {}
    }).then(user => {
      $.removeCookie('auth_token');
      window.location.reload()
    })
  }

</script>
